# Docker

**Внимание! Материал будет дополняться.**

## Установка на Linux

```
sudo apt update
sudo apt install apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
sudo apt update
apt-cache policy docker-ce
sudo apt install docker-ce
```

Далее перейти в конфиг
```
sudo nano /lib/systemd/system/docker.service
```

Заменить там строку
```
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
На
ExecStart=/usr/bin/dockerd --mtu 1450 -H fd:// --containerd=/run/containerd/containerd.sock
```

Перезапустить Docker
```
sudo systemctl daemon-reload
sudo service docker restart
```

Добавить себя в группу Docker
```
sudo usermod -a -G docker имяПользователя
```

### Другой способ установки

```
curl -sSL https://get.docker.com/ | sh
```




## Начало работы

Docker нужен для сборки, транспортировки и запуска приложений в контейнерами, которые являются изолированными виртуальными средами. программа, которая должна запускаться в Docker, называется образом, а запущенная программа - контейнером.

После установки проще пользоваться Докером из терминала.

```cmd
docker images # Показать образы
docker ps # Показать контейнеры
```

### Пример простой работы с Docker

Создадим простой Python файл с следующим содержимым.
```python
print("Hello, World")
```

Далее нужно создать файл с именем Dockerfile рядом с файлом. Это нужно, для того, чтоб Докер понимал где и как ему работать. Содержимое файла ниже.
```dockerfile
FROM python:3.6
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app
COPY . /usr/src/app
CMD ["python","main.py"]
```

Образ создается 1 раз и изменить его не удастся - только пересоздать. В примере выше в первой строке указан образ, который будет взят за основу - в данном случае это Python. Во второй строке выполняется команда, которая создает в образе рекурсивно папки. В третьей строке идет переход в папку app. В четвертой строке идет копирование всех файлов проекта в образ, а конкретно в папку app. После этого, в пятой строке запускается питоновский файл на выполнение.

Далее нужно ввести команду `docker build -t названиеОбраза .`. Имя не должно иметь заглавные буквы. После ввода команды Docker ищет python локально. Если его нет, он загружает образ из DockerHub. Так же идет докачка и других зависимостей. Для запуска нужно ввести `docker run названиеОбраза`.

После отработки программы контейнер деактивируется, но не исчезает. Чтобы увидеть все контейнеры нужно выполнить `docker ps -a`.

для удаления контейнера можно использовать `docker rm контейнер` вместо контейнера можно передать имя, идентификатор и так далее. Если нужно удалить все неактивные контейнеры, то можно написать `docker container prum` Для того, чтобы контейнер удалился автоматически после выполнения можно ввести `docker run --rm айдиКонтейнера`.

Для запуска  в фоновом режиме воспользуйтесь `docker run -d названиеОбраза`. Для остановки контейнера введите `docker stop АайдиКонтейнера`, а для запуска контейнера - `docker start АайдиКонтейнера`.

Для удаления образа воспользуйтесь `docker rmi образ`.Или для удаления всех неиспользуемых образов `docker image prum`.




## Установка модулей Python

Для установки модулей можно поступить следующими способами. Создать в проекте файл requirements.txt и в него вписать те библиотеки, которые нужно установить. Можно указать версию библиотеки, поставив двойное равно и указав версию. Далее в Dockerfile перед последней строкой написать `RUN pip install --no-cache-dir -r requirements.txt`. Параметр no-cache-dir нужен, чтобы не создавать папку с кэшем и тем самым немного разгрузить проект.




## Другие команды

Для запуска контейнера с падением через время, нужно в docker run вписать sleep количествоСекунд. 
Чтобы узнать подробную информацию о контейнере, введите `docker inspect имяКонтейнера`.
Чтобы создать волюм введите `docker run -v путьНаХосте:путьВКонтейнере`.
Чтобы увидеть информацию о потреблении ресурсов запущенными контейнерами используется команда `docker stats`. 




## Сети

В Docker есть 4 вида сетей. 

**Bridge** - сеть по умолчанию. При помощи этой сети контейнеры могут связываться между собой. Доступ во внешний мир у контейнера может быть, если пробросить порт. 
**Host** используется сеть хоста. Работает быстрее, но теряется принцип изоляции и может снизиться безопасность. 
**None** - полная изоляция контейнера от сети.
**Owerlay** позволяет настроить связь контейнеров, которые находятся на разных хостах. Используется в Docker Swarm. 
Macvlan позволяет каждому контейнеру назначить mac адрес, сделав из контейнера отдельное устройство. 

### Создание сетей

Простое создание сети
```
docker network create названиеСети
```

По умолчанию будет создан тип соединения Bridge, но можно задать и другой тип. 
```
docker network create my-network -d типСети
```

Просмотреть список сетей:
```
docker network ls
```

Просмотреть подробную информацию о сети:
```
docker network inspect названиеСети
```

Удалить сеть:
```
docker network rm названиеСети
```

Удалить все сети:
```
docker network prune
```

Присвоить сеть при запуске нового контейнера:
```
docker run --network названиеСети
```

Подключить существующий контейнер к сети:
```
docker network connect названиеСети названиеКонтейнера
```

Отключить существующий контейнер от сети:
```
docker network disconnect названиеСети названиеКонтейнера
```


## Где хранятся образы на диске

Образы хранятся по данному пути `c:\Users\user\AppData\Local\Docker\wsl\`


## Docker compose

Docker compose нужен для быстрого запуска многоконтейнерных приложений. 

`docker-compose up` - запустить приложение. `docker-compose down` - остановить приложение и удалить его контейнеры. 

Для работы с docker compose нужно создать файл с инструкциями `docker-compose.yml`. 

Шаблон файла

```docker-compose
name: myapp
services:
    - ...
networks:
    - ...
volumes:
    - ...
```

`name`-имя проекта. services - перечень сервисов. Сервисами называются образы вместе с вспомогательными параметрами. Названия сервисов можно давать произвольно. `networks` - сети. `volumes` - волюмы. Вот еще простой пример:

```
services:
  cont1:
    container_name: c1
    tty: true
    image: busybox
  cont2:
    container_name: c2
    tty: true
    image: busybox
```

В данном примере cont1 и cont2 - названия сервисов, то есть контейнеров, которые будут созданы и запущены. Далее можно увидеть другие параметры сервисов. container_name - имя, которое будет присвоено контейнеру. tty - отвечает, будет ли контейнер выключаться после срабатывания - в данном случае не будет. image - название образа, на основе которого будет создан контейнер.




## Если DockerHub заблокирован

1. Найти конфиг. На Linux `/etc/docker/daemon.json`. На Windows `C:\Users\<Пользователь>\.docker\daemon.json`. 
2. Прописать в нем и перезапустить Docker. 
```
{ "registry-mirrors" : [ "https://dockerhub.timeweb.cloud" ] }
```




## Некоторые шаблоны Dockerfile для Python

```Dockerfile
FROM python:3.9-slim-bullseye
WORKDIR /app
COPY requirements.txt requirements.txt
RUN pip3 install -r requirements.txt
COPY . .
CMD ["python3", "app.py"]
```

Flask

```dockerfile
CMD [ "python3", "-m" , "flask", "run", "--host=0.0.0.0"]
```

Django

```dockerfile
CMD ["python3", "manage.py", "runserver", "0.0.0.0:8000"]
```
